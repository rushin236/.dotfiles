#!/usr/bin/env bash

# === Log Configuration ===
LOG_FILE="/tmp/tmux-kill.log"
OLD_LOG_FILE="/tmp/tmux-kill.log.old"

# Rotate log if it exists
if [[ -f "$LOG_FILE" ]]; then
    mv "$LOG_FILE" "$OLD_LOG_FILE"
fi

# Start fresh log
echo "[$(date)] >>> Starting tmux session killer with args: $@" > "$LOG_FILE"

# Stream all output to log file
exec >>"$LOG_FILE" 2>&1

# === Logging Functions ===
log_info() {
    echo "[INFO] $*"
}

log_success() {
    echo "[SUCCESS] $*"
}

log_warning() {
    echo "[WARNING] $*"
}

log_error() {
    echo "[ERROR] $*" >&2
}

# === Configuration ===
FZF_PATH="$HOME/.fzf/bin/fzf"

log_info "FZF_PATH: $FZF_PATH"

# === Check for fzf ===
log_info "Checking for fzf"
if [[ ! -x "$FZF_PATH" ]]; then
    log_error "fzf not found at: $FZF_PATH"
    log_error "Install fzf or fix the FZF_PATH variable"
    exit 1
fi
log_success "Found fzf at: $FZF_PATH"

# === Check if tmux is running ===
# if ! pgrep -x tmux >/dev/null; then
#     log_warning "No tmux server is running"
#     exit 0
# fi
# log_info "Tmux server is running"

# === Get current session ===
current_session=$(tmux display-message -p '#S' 2>/dev/null)
if [[ -n "$current_session" ]]; then
    log_info "Currently inside tmux session: $current_session"
else
    log_info "Not currently attached to any tmux session"
    current_session=""
fi

# === List available sessions ===
log_info "Fetching list of tmux sessions"
all_sessions=$(tmux list-sessions -F "#S" 2>/dev/null)
if [[ -z "$all_sessions" ]]; then
    log_warning "No tmux sessions found"
    exit 0
fi

session_count=$(echo "$all_sessions" | wc -l)
log_info "Found $session_count total session(s)"

# Exclude current session if we're inside one
if [[ -n "$current_session" ]]; then
    available_sessions=$(echo "$all_sessions" | grep -v "^$current_session$")
else
    available_sessions="$all_sessions"
fi

if [[ -z "$available_sessions" ]]; then
    log_warning "No sessions available to kill (only current session exists)"
    if [[ -n "$TMUX" ]]; then
        tmux display-message "No other tmux sessions available except the current one."
    fi
    exit 0
fi

available_count=$(echo "$available_sessions" | wc -l)
log_info "Available sessions to kill: $available_count"
log_info "Sessions list:"
echo "$available_sessions" | while read -r s; do log_info "  - $s"; done

# === Interactive selection with fzf ===
log_info "Launching fzf for session selection"
selected_sessions=$(
    echo "$available_sessions" | "$FZF_PATH" -m \
        --prompt="Select tmux sessions to KILL > " \
        --header="Use TAB to select multiple, ENTER to confirm"
)
fzf_exit=$?

if [[ $fzf_exit -ne 0 ]]; then
    log_info "fzf cancelled or failed (exit code: $fzf_exit)"
    exit 0
fi

if [[ -z "$selected_sessions" ]]; then
    log_info "No sessions selected via fzf"
    exit 0
fi

selected_count=$(echo "$selected_sessions" | wc -l)
log_success "Selected $selected_count session(s) to kill:"
echo "$selected_sessions" | while read -r s; do log_info "  - $s"; done

# === Confirmation ===
log_info "Requesting user confirmation"
echo "" > /dev/tty
echo "The following session(s) will be KILLED:" > /dev/tty
echo "$selected_sessions" > /dev/tty
echo "" > /dev/tty
echo -n "Are you sure? [y/N] " > /dev/tty
read -r confirm < /dev/tty

log_info "User response: ${confirm:-<empty>}"

if [[ "$confirm" != [yY] ]]; then
    log_info "Aborted by user"
    exit 0
fi

log_success "User confirmed, proceeding with kill operation"

# === Kill sessions ===
killed_count=0
failed_count=0

while IFS= read -r session; do
    log_info "Attempting to kill session: $session"

    if tmux kill-session -t "$session" 2>/dev/null; then
        log_success "Killed session: $session"
        ((killed_count++))
    else
        log_error "Failed to kill session: $session"
        ((failed_count++))
    fi
done <<< "$selected_sessions"

# === Summary ===
log_info "========================================="
log_info "Kill operation summary:"
log_success "Successfully killed: $killed_count session(s)"
if [[ $failed_count -gt 0 ]]; then
    log_error "Failed to kill: $failed_count session(s)"
fi
log_info "========================================="

if [[ $failed_count -gt 0 ]]; then
    log_error "Script completed with errors"
    exit 1
else
    log_success "Script completed successfully"
    exit 0
fi
